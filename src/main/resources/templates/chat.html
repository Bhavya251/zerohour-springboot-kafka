<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ZeroHour</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<!--    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.2.0/bundles/stomp.umd.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>

    <style>

        .message-text {
          flex: 1;
          word-wrap: break-word;
        }

        .message-time {
          font-size: 0.75rem; /* smaller font */
          white-space: nowrap; /* prevent wrapping */
          flex-shrink: 0;          /* timestamp keeps natural size */
        }
    </style>
</head>
<body class="bg-dark text-white" data-bs-theme="dark" >
    <div class="container mt-4 border-rounded p-3 mb-3">
        <h2 class="text-center">ZeroHour</h2>

        <div id="chatWindow" class="shadow-sm p-3 mb-3 bg-body-tertiary rounded" style="height: 400px; overflow-y: auto;">

        </div>
        <div class="input-group border-rounded p-3 mb-1" style="height: 50px; display: flex;">
            <input id="senderInput" class="form-control" type="text" placeholder="Enter your name..." />
            <button id="saveButton" class="btn btn-secondary">Save & Connect</button>
        </div>

        <div class="input-group border-rounded p-3" style="height: 80px; display: flex;">
            <input id="senderMessage" class="form-control" type="text" placeholder="Enter your message..." />
            <button id="sendButton" class="btn btn-secondary">Send</button>
        </div>
    </div>
</body>
<script>

    function setConnected(connected) {
        document.getElementById('chatWindow').hidden = !connected;
        document.getElementById('sendButton').disabled = !connected;
        document.getElementById('senderInput').readOnly = connected;
        document.getElementById('senderInput').disabled = connected;
        if (connected){
            document.getElementById('saveButton').innerText = 'Connected';
            document.getElementById('saveButton').disabled = connected;
        }

    }

    function connect() {
        const socket = new SockJS('/chat');
        stompClient = Stomp.over(socket);
        setConnected(true);
        stompClient.connect({}, function (frame) {
            stompClient.subscribe('/topic/messages', function (message) {
                showMessage(JSON.parse(message.body));
            });
            console.log('Connected: ' + frame);
        });
    }
    function showMessage(message) {
        const chatWindow = document.getElementById('chatWindow');

        // parent container (flex row)
        const messageElement = document.createElement('div');
        messageElement.classList.add(
            'd-flex',              // flexbox row
            'justify-content-between',
            'align-items-center',
            'mb-1',
            'p-1'
        );

        // text div
        const textDiv = document.createElement('div');
        textDiv.classList.add('message-text');
        textDiv.textContent = (message.sender || 'Unknown') + ': ' + (message.content || '');

        // time div
        const timeDiv = document.createElement('div');
        timeDiv.classList.add('message-time', 'text-muted', 'ms-2');
        timeDiv.textContent = new Date().toLocaleString(undefined, {
            dateStyle: 'medium',
            timeStyle: 'short'
        });

        // append both into parent
        messageElement.appendChild(textDiv);
        messageElement.appendChild(timeDiv);

        // add to chat
        chatWindow.appendChild(messageElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function sendMessage() {
        var sender = document.getElementById('senderInput').value;
        var content = document.getElementById('senderMessage').value;
        var chatMessage = {
            sender: sender,
            content: content
        }
        stompClient.send("/app/sendMessage", {}, JSON.stringify(chatMessage));
        document.getElementById('senderMessage').value = '';
    }

    document.getElementById('saveButton').onclick = connect;
    document.getElementById('sendButton').onclick = sendMessage;
    window.onload = setConnected(false);
</script>
</html>